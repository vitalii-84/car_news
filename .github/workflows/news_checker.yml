name: Car News Checker

# ===============================
# Автоматичний запуск та ручний тригер
# ===============================
on:
  schedule:
    - cron: '0 11 * * *'
      timezone: 'Europe/Kiev'  # 11:00 Київ
    - cron: '0 16 * * *'
      timezone: 'Europe/Kiev'  # 16:00 Київ
  workflow_dispatch:

# ===============================
# Обмеження паралельних запусків
# ===============================
concurrency:
  group: car-news-checker
  cancel-in-progress: true

jobs:
  check-news:
    runs-on: ubuntu-latest

    steps:
      # ===============================
      # Клон репозиторію
      # ===============================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===============================
      # Налаштування Python
      # ===============================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ===============================
      # Встановлення залежностей
      # ===============================
      - name: Install dependencies
        run: pip install -r car_news/requirements.txt

      # ===============================
      # Відновлення кешу last_post_id
      # ===============================
      - name: Restore last_post_id cache
        uses: actions/cache@v4
        with:
          path: car_news/last_post_id.txt
          key: last-post-id-${{ runner.os }}
          restore-keys: |
            last-post-id-

      # ===============================
      # Запуск скрипта
      # ===============================
      - name: Run news checker
        run: python car_news/check_latest_news.py
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      # ===============================
      # Оновлення кешу last_post_id
      # ===============================
      - name: Save updated last_post_id to cache
        uses: actions/cache@v4
        with:
          path: car_news/last_post_id.txt
          key: last-post-id-${{ runner.os }}-${{ github.run_id }}
